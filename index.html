<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Student Portal</title>

  <!-- Mobile / PWA meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#1159c4">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Student Portal">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

  <style>
    :root{
      --brand:#1159c4;
      --bg:#f4f6ff;
      --card:#ffffff;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }
    a{text-decoration:none;color:inherit}

    /* HEADER */
    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      background:var(--brand);
      color:#fff;
      padding:16px 16px 20px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom-left-radius:18px;
      border-bottom-right-radius:18px;
      box-shadow:0 10px 24px rgba(15,23,42,.35);
    }
    .logo{
      width:40px;
      height:40px;
      border-radius:10px;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .logo img{
      width:80%;
      height:80%;
      object-fit:contain;
    }
    .header-text{flex:1;min-width:0}
    .header-title{
      font-size:16px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .header-sub{
      font-size:12px;
      opacity:.9;
    }
    .header-actions button{
      background:transparent;
      border:0;
      color:#fff;
      padding:6px;
      cursor:pointer;
    }

    /* LAYOUT */
    main{
      padding:12px;
      padding-bottom:90px;
      max-width:900px;
      margin:0 auto;
    }
    .page{display:none;animation:fadeUp .25s ease-out;}
    .page.active{display:block;}
    @keyframes fadeUp{
      from{opacity:0;transform:translateY(6px);}
      to{opacity:1;transform:none;}
    }

    /* CARDS */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:14px 14px;
      box-shadow:0 10px 28px rgba(15,23,42,.08);
      margin-bottom:12px;
    }

    .pill{
      border-radius:999px;
      border:1px solid #e5e7eb;
      padding:6px 14px;
      font-size:12px;
      background:#fff;
    }
    .muted{color:var(--muted);}
    .small{font-size:13px;}

    /* HOME – quick actions & timetable snapshot */
    .home-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .home-top-main{flex:1;}
    .home-top-title{font-weight:800;}
    .home-top-sub{font-size:13px;color:var(--muted);margin-top:4px;}

    .quick-grid{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .quick-item{
      flex:1;
      min-width:80px;
      border-radius:14px;
      background:#f9fbff;
      box-shadow:0 8px 18px rgba(15,23,42,.04);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:8px 4px;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .quick-item:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 24px rgba(15,23,42,.08);
    }
    .quick-label{font-size:12px;margin-top:4px;}

    .snap-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .snap-grid{
      display:flex;
      gap:8px;
      overflow-x:auto;
      padding-bottom:4px;
    }
    .snap-card{
      min-width:90px;
      border-radius:12px;
      background:#f6f8ff;
      padding:8px;
      cursor:pointer;
    }
    .snap-day{font-weight:700;color:var(--brand);font-size:13px;}
    .snap-time{font-size:13px;margin-top:2px;}
    .snap-sub{font-size:12px;color:var(--muted);margin-top:2px;}

    /* TIMETABLE */
    .day-card{margin-bottom:12px;}
    .day-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .slot{
      background:#f9fbff;
      border-radius:12px;
      padding:10px;
      margin-top:6px;
    }
    .slot-title{font-weight:700;font-size:14px;}
    .slot-meta{font-size:13px;color:var(--muted);margin-top:2px;}

    /* ASSIGNMENTS */
    .assign-controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      margin-bottom:8px;
    }
    .input, .select{
      padding:8px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#fff;
      font-size:13px;
    }
    .assign-list{display:flex;flex-direction:column;gap:8px;margin-top:6px;}
    .assign-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .assign-left{flex:1;}
    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      background:#e0ebff;
      color:var(--brand);
      font-weight:600;
    }

    /* PROFILE */
    .profile-card{text-align:center;}
    .avatar{
      width:90px;
      height:90px;
      border-radius:24px;
      background:#ffffff;
      margin:0 auto 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow:0 10px 26px rgba(15,23,42,.15);
    }
    .avatar span{
      font-weight:800;
      font-size:26px;
      color:var(--brand);
    }
    .profile-name{font-weight:800;font-size:18px;margin-top:4px;}
    .profile-degree{font-size:13px;color:var(--muted);}
    .profile-info{
      text-align:left;
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .profile-row{
      background:#f9fbff;
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
    }
    .profile-label{font-weight:600;font-size:12px;color:var(--muted);}

    /* MODAL */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal{
      background:#fff;
      width:min(420px,94vw);
      border-radius:16px;
      padding:14px 14px 16px;
      box-shadow:0 20px 40px rgba(15,23,42,.55);
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-head h3{font-size:16px;}
    .modal-body{font-size:13px;color:#111827;}
    .btn-link{
      border:0;
      background:#eef2ff;
      padding:7px 10px;
      border-radius:10px;
      font-size:13px;
      cursor:pointer;
    }

    /* BOTTOM NAV */
    .bottom-nav{
      position:fixed;
      left:8px;
      right:8px;
      bottom:10px;
      background:#ffffff;
      border-radius:18px;
      padding:6px 4px;
      display:flex;
      justify-content:space-around;
      box-shadow:0 10px 30px rgba(15,23,42,.18);
      z-index:30;
    }
    .nav-item{
      flex:1;
      text-align:center;
      font-size:11px;
      color:var(--muted);
      cursor:pointer;
      padding:4px 0;
    }
    .nav-item span{
      display:block;
      margin-top:2px;
    }
    .nav-item.active{
      color:var(--brand);
      font-weight:600;
    }

    @media (min-width:900px){
      main{padding-top:16px;}
    }
  </style>
</head>
<body>

<header class="topbar" role="banner">
  <div class="logo">
    <!-- Uses your emblem -->
    <img src="icons/icon-192.png" alt="Portal logo">
  </div>
  <div class="header-text">
    <div class="header-title" id="appTitle">Student Portal — Home</div>
    <div class="header-sub">Welcome, <span id="welcomeName">Student</span></div>
  </div>
  <div class="header-actions">
    <button aria-label="Search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/>
        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="homePage" class="page active">
    <div class="card">
      <div class="home-top">
        <div class="home-top-main">
          <div class="small muted">Next class</div>
          <div class="home-top-title">EDUC 101 — Professional Experience</div>
          <div class="home-top-sub">Today · 9:00 – 12:00 · Building A</div>
        </div>
        <div><span class="pill">On campus</span></div>
      </div>
    </div>

    <div class="card">
      <div class="home-top">
        <div>
          <div class="small muted">Quick actions</div>
          <div class="home-top-title">Open tools & links</div>
        </div>
      </div>
      <div class="quick-grid">
        <div class="quick-item" onclick="openFeature('email')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="5" width="18" height="14" rx="2" stroke="#1159c4" stroke-width="1.6"/>
            <path d="M3 8.5l9 6 9-6" stroke="#1159c4" stroke-width="1.6"
                  stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="quick-label">Email</div>
        </div>
        <div class="quick-item" onclick="openFeature('maps')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M6 4l6-2 6 2v16l-6 2-6-2V4z" stroke="#1159c4" stroke-width="1.6"
                  stroke-linejoin="round"/>
            <path d="M12 2v18" stroke="#1159c4" stroke-width="1.6" stroke-linejoin="round"/>
          </svg>
          <div class="quick-label">Maps</div>
        </div>
        <div class="quick-item" onclick="switchTo('assignments')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="4" width="18" height="16" rx="2" stroke="#1159c4" stroke-width="1.6"/>
            <path d="M8 9h8" stroke="#1159c4" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <div class="quick-label">Assignments</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="snap-header">
        <div>
          <div class="small muted">Upcoming week</div>
          <div class="home-top-title">Timetable snapshot</div>
        </div>
        <div class="small muted">Tap to open</div>
      </div>
      <div class="snap-grid">
        <div class="snap-card" onclick="switchTo('timetable')">
          <div class="snap-day">Mon</div>
          <div class="snap-time">9:00</div>
          <div class="snap-sub">EDUC 101</div>
        </div>
        <div class="snap-card" onclick="switchTo('timetable')">
          <div class="snap-day">Tue</div>
          <div class="snap-time">10:00</div>
          <div class="snap-sub">EDUC 202</div>
        </div>
        <div class="snap-card" onclick="switchTo('timetable')">
          <div class="snap-day">Thu</div>
          <div class="snap-time">14:00</div>
          <div class="snap-sub">EDUC 301</div>
        </div>
      </div>
    </div>
  </section>

  <!-- TIMETABLE -->
  <section id="timetablePage" class="page">
    <div class="card">
      <div class="day-head">
        <div>
          <div class="small muted">This week</div>
          <div class="home-top-title">My timetable</div>
        </div>
        <div class="small muted">Local time</div>
      </div>

      <div class="day-card">
        <div class="day-head">
          <div class="home-top-title">Monday</div>
          <div class="small muted">2 sessions</div>
        </div>
        <div class="slot">
          <div class="slot-title">EDUC 101</div>
          <div class="slot-meta">9:00 – 12:00 · Building A · Room 21</div>
        </div>
        <div class="slot">
          <div class="slot-title">Study Group</div>
          <div class="slot-meta">13:00 – 15:00 · Library Hub</div>
        </div>
      </div>

      <div class="day-card">
        <div class="day-head">
          <div class="home-top-title">Tuesday</div>
          <div class="small muted">1 session</div>
        </div>
        <div class="slot">
          <div class="slot-title">EDUC 202</div>
          <div class="slot-meta">10:00 – 12:00 · Studio 3</div>
        </div>
      </div>

      <div class="day-card">
        <div class="day-head">
          <div class="home-top-title">Thursday</div>
          <div class="small muted">1 session</div>
        </div>
        <div class="slot">
          <div class="slot-title">EDUC 301</div>
          <div class="slot-meta">14:00 – 16:00 · Tech Workshop</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ASSIGNMENTS -->
  <section id="assignmentsPage" class="page">
    <div class="card">
      <div class="home-top">
        <div>
          <div class="small muted">Track your work</div>
          <div class="home-top-title">Assignments & grades</div>
        </div>
        <div>
          <span class="small muted">Average</span>
          <span id="avgBadge" class="badge">--%</span>
        </div>
      </div>

      <div class="assign-controls">
        <select id="filterUnit" class="select" onchange="renderAssignments()">
          <option value="all">All units</option>
        </select>
        <select id="filterStatus" class="select" onchange="renderAssignments()">
          <option value="all">All statuses</option>
          <option value="submitted">Submitted</option>
          <option value="pending">Pending</option>
          <option value="overdue">Overdue</option>
        </select>
        <select id="sortBy" class="select" onchange="renderAssignments()">
          <option value="due_asc">Due — soonest</option>
          <option value="due_desc">Due — latest</option>
          <option value="grade_desc">Grade — high → low</option>
          <option value="grade_asc">Grade — low → high</option>
        </select>
      </div>

      <div id="assignList" class="assign-list"></div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-link" onclick="openAddAssignment()">+ Add assignment</button>
        <button class="btn-link" onclick="exportAssignments()">Export JSON</button>
      </div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="profilePage" class="page">
    <div class="card profile-card">
      <div class="avatar"><span id="avatarInitials">JD</span></div>
      <div class="profile-name" id="profileName">John Doe</div>
      <div class="profile-degree" id="profileDegree">Bachelor of Education</div>

      <div class="profile-info">
        <div class="profile-row">
          <div class="profile-label">Age</div>
          <div id="profileAge">19</div>
        </div>
        <div class="profile-row">
          <div class="profile-label">Email</div>
          <div id="profileEmail">lucianorostirolla0@gmail.com</div>
        </div>
        <div class="profile-row">
          <div class="profile-label">Phone Number</div>
          <div id="profileEmail">0415-601-071</div>
        </div>
      </div>

      <div style="margin-top:12px;text-align:left">
        <button class="btn-link" onclick="editProfile()">Edit profile</button>
      </div>
    </div>
  </section>
</main>

<!-- MODAL -->
<div id="modal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-head">
      <h3 id="modalTitle">Modal</h3>
      <button class="btn-link" onclick="closeModal()">Close</button>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <div class="nav-item active" data-page="home" onclick="switchTo('home')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <path d="M3 11.5L12 5l9 6.5" stroke="currentColor" stroke-width="1.6"
            stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M5 21V11h14v10" stroke="currentColor" stroke-width="1.6"
            stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span>Home</span>
  </div>
  <div class="nav-item" data-page="timetable" onclick="switchTo('timetable')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.6"/>
      <path d="M16 2v4M8 2v4" stroke="currentColor" stroke-width="1.6"/>
    </svg>
    <span>Timetable</span>
  </div>
  <div class="nav-item" data-page="assignments" onclick="switchTo('assignments')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.6"/>
      <path d="M9 8h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <span>Assignments</span>
  </div>
  <div class="nav-item" data-page="profile" onclick="switchTo('profile')">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.6"/>
      <path d="M6 20c1.5-3 5-5 6-5s4.5 2 6 5" stroke="currentColor" stroke-width="1.6"
            stroke-linecap="round"/>
    </svg>
    <span>Profile</span>
  </div>
</nav>

<script>
  /* STATE */
  const defaultProfile = {
    name:"John Doe",
    age:21,
    degree:"Bachelor of Education",
    id:"123456",
    email:"john@example.com"
  };
  const demoAssignments = [
    {id:"a1",unit:"EDUC 101",title:"Professional Experience Reflection",due:"2025-11-15",status:"submitted",grade:88,notes:"Submitted via portal"},
    {id:"a2",unit:"EDUC 202",title:"Design Teaching Plan",due:"2025-11-25",status:"pending",grade:null,notes:""},
    {id:"a3",unit:"EDUC 301",title:"Tech Workshop Report",due:"2025-10-28",status:"overdue",grade:72,notes:"Late submission"},
  ];
  let state = JSON.parse(localStorage.getItem("sp_state") || "null");
  if(!state){
    state = {profile:defaultProfile,assignments:demoAssignments};
    localStorage.setItem("sp_state",JSON.stringify(state));
  }

  /* NAVIGATION */
  function switchTo(page){
    const map = {home:"homePage",timetable:"timetablePage",assignments:"assignmentsPage",profile:"profilePage"};
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById(map[page]).classList.add("active");
    document.querySelectorAll(".nav-item").forEach(n=>{
      n.classList.toggle("active", n.dataset.page===page);
    });
    const titleMap={home:"Home",timetable:"Timetable",assignments:"Assignments",profile:"Profile"};
    document.getElementById("appTitle").innerText="Student Portal — "+titleMap[page];
    if(page==="assignments") renderAssignments();
    if(page==="profile") renderProfile();
  }

  /* PROFILE */
  function renderProfile(){
    const p=state.profile;
    document.getElementById("profileName").innerText=p.name;
    document.getElementById("profileDegree").innerText=p.degree;
    document.getElementById("profileAge").innerText=p.age;
    document.getElementById("profileID").innerText=p.id;
    document.getElementById("profileEmail").innerText=p.email;
    const first=p.name.split(" ")[0]||"Student";
    document.getElementById("welcomeName").innerText=first;
    const initials=(p.name.split(" ").map(s=>s[0]).join("").slice(0,2)||"SP").toUpperCase();
    document.getElementById("avatarInitials").innerText=initials;
  }
  function editProfile(){
    const p=state.profile;
    const body=`
      <label>Name<br><input id="pf_name" class="input" value="${escapeHtml(p.name)}"></label><br>
      <label>Age<br><input id="pf_age" class="input" type="number" value="${p.age}"></label><br>
      <label>Degree<br><input id="pf_deg" class="input" value="${escapeHtml(p.degree)}"></label><br>
      <label>Email<br><input id="pf_email" class="input" value="${escapeHtml(p.email)}"></label><br>
      <button class="btn-link" onclick="saveProfile()">Save</button>
    `;
    openModal("Edit profile",body);
  }
  function saveProfile(){
    const p=state.profile;
    p.name=document.getElementById("pf_name").value||p.name;
    p.age=Number(document.getElementById("pf_age").value)||p.age;
    p.degree=document.getElementById("pf_deg").value||p.degree;
    p.email=document.getElementById("pf_email").value||p.email;
    persist();
    renderProfile();
    closeModal();
  }

  /* ASSIGNMENTS */
  function renderAssignments(){
    const list=document.getElementById("assignList");
    list.innerHTML="";
    const unitSelect=document.getElementById("filterUnit");
    const statusFilter=document.getElementById("filterStatus").value;
    const sortBy=document.getElementById("sortBy").value;

    const units=[...new Set(state.assignments.map(a=>a.unit))];
    unitSelect.innerHTML='<option value="all">All units</option>'+units.map(u=>`<option value="${u}">${u}</option>`).join("");
    let items=[...state.assignments];

    const uVal=unitSelect.value;
    if(uVal!=="all") items=items.filter(a=>a.unit===uVal);
    if(statusFilter!=="all") items=items.filter(a=>a.status===statusFilter);

    items.sort((a,b)=>{
      if(sortBy==="due_asc") return new Date(a.due)-new Date(b.due);
      if(sortBy==="due_desc") return new Date(b.due)-new Date(a.due);
      if(sortBy==="grade_desc") return (b.grade||0)-(a.grade||0);
      if(sortBy==="grade_asc") return (a.grade||0)-(b.grade||0);
      return 0;
    });

    const graded=state.assignments.filter(a=>typeof a.grade==="number");
    const avg=graded.length?Math.round(graded.reduce((s,x)=>s+x.grade,0)/graded.length):0;
    document.getElementById("avgBadge").innerText=graded.length?avg+"%":"--%";

    if(!items.length){
      list.innerHTML='<div class="small muted">No assignments match your filters.</div>';
      return;
    }
    items.forEach(a=>{
      const dueStr=isNaN(new Date(a.due))?"—":new Date(a.due).toLocaleDateString();
      const row=document.createElement("div");
      row.className="card assign-row";
      row.innerHTML=`
        <div class="assign-left">
          <div><strong>${escapeHtml(a.title)}</strong></div>
          <div class="small muted">${escapeHtml(a.unit)} · Due ${dueStr}</div>
        </div>
        <div style="text-align:right">
          <div><strong>${typeof a.grade==="number"?a.grade+"%":"—"}</strong></div>
          <div class="small muted">${a.status}</div>
          <button class="btn-link" onclick="openAssignment('${a.id}')">Open</button>
        </div>
      `;
      list.appendChild(row);
    });
  }
  function openAssignment(id){
    const a=state.assignments.find(x=>x.id===id);
    if(!a) return;
    const body=`
      <strong>${escapeHtml(a.title)}</strong><br>
      <span class="small muted">${escapeHtml(a.unit)}</span><br><br>
      <div><strong>Due:</strong> ${a.due}</div>
      <div><strong>Status:</strong> ${a.status}</div>
      <div><strong>Grade:</strong> ${typeof a.grade==="number"?a.grade+"%":"—"}</div><br>
      <div><strong>Notes</strong><br>${escapeHtml(a.notes||"—")}</div><br>
      <button class="btn-link" onclick="editAssignment('${a.id}')">Edit</button>
      <button class="btn-link" onclick="deleteAssignment('${a.id}')">Delete</button>
    `;
    openModal("Assignment",body);
  }
  function openAddAssignment(){
    const body=formMarkup();
    openModal("Add assignment",body);
  }
  function editAssignment(id){
    const a=state.assignments.find(x=>x.id===id);
    if(!a) return;
    openModal("Edit assignment",formMarkup(a));
  }
  function formMarkup(a={id:"",unit:"",title:"",due:"",status:"pending",grade:"",notes:""}){
    const units=[...new Set(state.assignments.map(x=>x.unit))];
    const unitOptions='<option value="">Select unit</option>'+units.map(u=>`<option value="${escapeHtml(u)}" ${a.unit===u?"selected":""}>${escapeHtml(u)}</option>`).join("");
    return `
      <label>Unit<br>
        <select id="fa_unit" class="select">${unitOptions}</select>
      </label><br>
      <label>Title<br>
        <input id="fa_title" class="input" value="${escapeHtml(a.title)}">
      </label><br>
      <label>Due date<br>
        <input id="fa_due" class="input" type="date" value="${a.due}">
      </label><br>
      <label>Status<br>
        <select id="fa_status" class="select">
          <option value="pending" ${a.status==="pending"?"selected":""}>Pending</option>
          <option value="submitted" ${a.status==="submitted"?"selected":""}>Submitted</option>
          <option value="overdue" ${a.status==="overdue"?"selected":""}>Overdue</option>
        </select>
      </label><br>
      <label>Grade (0–100)<br>
        <input id="fa_grade" class="input" type="number" min="0" max="100" value="${a.grade??""}">
      </label><br>
      <label>Notes<br>
        <textarea id="fa_notes" class="input" rows="3">${escapeHtml(a.notes||"")}</textarea>
      </label><br>
      <button class="btn-link" onclick="saveAssignment('${a.id||""}')">Save</button>
    `;
  }
  function saveAssignment(id){
    const unit=document.getElementById("fa_unit").value||"Unspecified";
    const title=document.getElementById("fa_title").value||"Untitled";
    const due=document.getElementById("fa_due").value||"";
    const status=document.getElementById("fa_status").value||"pending";
    const gradeVal=document.getElementById("fa_grade").value;
    const grade=gradeVal===""?null:Number(gradeVal);
    const notes=document.getElementById("fa_notes").value||"";
    if(!id){
      const nid="a"+Math.random().toString(36).slice(2,9);
      state.assignments.push({id:nid,unit,title,due,status,grade,notes});
    }else{
      const a=state.assignments.find(x=>x.id===id);
      if(a){a.unit=unit;a.title=title;a.due=due;a.status=status;a.grade=grade;a.notes=notes;}
    }
    persist();
    closeModal();
    renderAssignments();
  }
  function deleteAssignment(id){
    if(!confirm("Delete this assignment?")) return;
    state.assignments=state.assignments.filter(x=>x.id!==id);
    persist();
    closeModal();
    renderAssignments();
  }
  function exportAssignments(){
    const blob=new Blob([JSON.stringify(state.assignments,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="assignments.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  /* MODAL + HELPERS */
  function openModal(title,html){
    document.getElementById("modalTitle").innerText=title;
    document.getElementById("modalBody").innerHTML=html;
    const m=document.getElementById("modal");
    m.style.display="flex";
    m.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    const m=document.getElementById("modal");
    m.style.display="none";
    m.setAttribute("aria-hidden","true");
  }
  function escapeHtml(s){
    if(!s) return "";
    return String(s).replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }
  function persist(){localStorage.setItem("sp_state",JSON.stringify(state));}
  function openFeature(name){alert("Open feature: "+name);}

  // init
  renderProfile();
  renderAssignments();
  document.getElementById("modal").addEventListener("click",e=>{
    if(e.target===document.getElementById("modal")) closeModal();
  });
  document.addEventListener("keydown",e=>{if(e.key==="Escape") closeModal();});

  // service worker (optional; only if you create sw.js)
  if("serviceWorker" in navigator){
    window.addEventListener("load",()=>navigator.serviceWorker.register("sw.js").catch(()=>{}));
  }
</script>
</body>
</html>
